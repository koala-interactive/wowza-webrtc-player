/**
 * @license wowza-video-webrtc-broadcaster 1.0.0
 * Copyright (c) 2018-2022 Koala Interactive, Inc.
 * License: MIT
 */
"use strict";function e(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function t(t){for(var n=1;n<arguments.length;n++){var r=null!=arguments[n]?arguments[n]:{};n%2?e(Object(r),!0).forEach((function(e){i(t,e,r[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(r)):e(Object(r)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(r,e))}))}return t}function n(e,t,n,r,i,s,o){try{var a=e[s](o),c=a.value}catch(e){return void n(e)}a.done?t(c):Promise.resolve(c).then(r,i)}function r(e){return function(){var t=this,r=arguments;return new Promise((function(i,s){var o=e.apply(t,r);function a(e){n(o,i,s,a,c,"next",e)}function c(e){n(o,i,s,a,c,"throw",e)}a(void 0)}))}}function i(e,t,n){return(t=function(e){var t=function(e,t){if("object"!=typeof e||null===e)return e;var n=e[Symbol.toPrimitive];if(void 0!==n){var r=n.call(e,t||"default");if("object"!=typeof r)return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==typeof t?t:t+""}(t))in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function s(){}function o(){o.init.call(this)}function a(e){return void 0===e._maxListeners?o.defaultMaxListeners:e._maxListeners}function c(e,t,n){if(t)e.call(n);else for(var r=e.length,i=v(e,r),s=0;s<r;++s)i[s].call(n)}function u(e,t,n,r){if(t)e.call(n,r);else for(var i=e.length,s=v(e,i),o=0;o<i;++o)s[o].call(n,r)}function d(e,t,n,r,i){if(t)e.call(n,r,i);else for(var s=e.length,o=v(e,s),a=0;a<s;++a)o[a].call(n,r,i)}function l(e,t,n,r,i,s){if(t)e.call(n,r,i,s);else for(var o=e.length,a=v(e,o),c=0;c<o;++c)a[c].call(n,r,i,s)}function h(e,t,n,r){if(t)e.apply(n,r);else for(var i=e.length,s=v(e,i),o=0;o<i;++o)s[o].apply(n,r)}function f(e,t,n,r){var i,o,c,u;if("function"!=typeof n)throw new TypeError('"listener" argument must be a function');if((o=e._events)?(o.newListener&&(e.emit("newListener",t,n.listener?n.listener:n),o=e._events),c=o[t]):(o=e._events=new s,e._eventsCount=0),c){if("function"==typeof c?c=o[t]=r?[n,c]:[c,n]:r?c.unshift(n):c.push(n),!c.warned&&(i=a(e))&&i>0&&c.length>i){c.warned=!0;var d=Error("Possible EventEmitter memory leak detected. "+c.length+" "+t+" listeners added. Use emitter.setMaxListeners() to increase limit");d.name="MaxListenersExceededWarning",d.emitter=e,d.type=t,d.count=c.length,u=d,"function"==typeof console.warn?console.warn(u):console.log(u)}}else c=o[t]=n,++e._eventsCount;return e}function p(e,t,n){var r=!1;function i(){e.removeListener(t,i),r||(r=!0,n.apply(e,arguments))}return i.listener=n,i}function m(e){var t=this._events;if(t){var n=t[e];if("function"==typeof n)return 1;if(n)return n.length}return 0}function v(e,t){for(var n=Array(t);t--;)n[t]=e[t];return n}Object.defineProperty(exports,"__esModule",{value:!0}),s.prototype=Object.create(null),o.EventEmitter=o,o.usingDomains=!1,o.prototype.domain=void 0,o.prototype._events=void 0,o.prototype._maxListeners=void 0,o.defaultMaxListeners=10,o.init=function(){this.domain=null,o.usingDomains&&(void 0).active,this._events&&this._events!==Object.getPrototypeOf(this)._events||(this._events=new s,this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},o.prototype.setMaxListeners=function(e){if("number"!=typeof e||e<0||isNaN(e))throw new TypeError('"n" argument must be a positive number');return this._maxListeners=e,this},o.prototype.getMaxListeners=function(){return a(this)},o.prototype.emit=function(e){var t,n,r,i,s,o,a,f="error"===e;if(o=this._events)f=f&&null==o.error;else if(!f)return!1;if(a=this.domain,f){if(t=arguments[1],!a){if(t instanceof Error)throw t;var p=Error('Uncaught, unspecified "error" event. ('+t+")");throw p.context=t,p}return t||(t=Error('Uncaught, unspecified "error" event')),t.domainEmitter=this,t.domain=a,t.domainThrown=!1,a.emit("error",t),!1}if(!(n=o[e]))return!1;var m="function"==typeof n;switch(r=arguments.length){case 1:c(n,m,this);break;case 2:u(n,m,this,arguments[1]);break;case 3:d(n,m,this,arguments[1],arguments[2]);break;case 4:l(n,m,this,arguments[1],arguments[2],arguments[3]);break;default:for(i=Array(r-1),s=1;s<r;s++)i[s-1]=arguments[s];h(n,m,this,i)}return!0},o.prototype.addListener=function(e,t){return f(this,e,t,!1)},o.prototype.on=o.prototype.addListener,o.prototype.prependListener=function(e,t){return f(this,e,t,!0)},o.prototype.once=function(e,t){if("function"!=typeof t)throw new TypeError('"listener" argument must be a function');return this.on(e,p(this,e,t)),this},o.prototype.prependOnceListener=function(e,t){if("function"!=typeof t)throw new TypeError('"listener" argument must be a function');return this.prependListener(e,p(this,e,t)),this},o.prototype.removeListener=function(e,t){var n,r,i,o,a;if("function"!=typeof t)throw new TypeError('"listener" argument must be a function');if(!(r=this._events))return this;if(!(n=r[e]))return this;if(n===t||n.listener&&n.listener===t)0==--this._eventsCount?this._events=new s:(delete r[e],r.removeListener&&this.emit("removeListener",e,n.listener||t));else if("function"!=typeof n){for(i=-1,o=n.length;o-- >0;)if(n[o]===t||n[o].listener&&n[o].listener===t){a=n[o].listener,i=o;break}if(i<0)return this;if(1===n.length){if(n[0]=void 0,0==--this._eventsCount)return this._events=new s,this;delete r[e]}else!function(e,t){for(var n=t,r=n+1,i=e.length;r<i;n+=1,r+=1)e[n]=e[r];e.pop()}(n,i);r.removeListener&&this.emit("removeListener",e,a||t)}return this},o.prototype.removeAllListeners=function(e){var t,n;if(!(n=this._events))return this;if(!n.removeListener)return 0===arguments.length?(this._events=new s,this._eventsCount=0):n[e]&&(0==--this._eventsCount?this._events=new s:delete n[e]),this;if(0===arguments.length){for(var r,i=Object.keys(n),o=0;o<i.length;++o)"removeListener"!==(r=i[o])&&this.removeAllListeners(r);return this.removeAllListeners("removeListener"),this._events=new s,this._eventsCount=0,this}if("function"==typeof(t=n[e]))this.removeListener(e,t);else if(t)do{this.removeListener(e,t[t.length-1])}while(t[0]);return this},o.prototype.listeners=function(e){var t,n=this._events;return n&&(t=n[e])?"function"==typeof t?[t.listener||t]:function(e){for(var t=Array(e.length),n=0;n<t.length;++n)t[n]=e[n].listener||e[n];return t}(t):[]},o.listenerCount=function(e,t){return"function"==typeof e.listenerCount?e.listenerCount(t):m.call(e,t)},o.prototype.listenerCount=m,o.prototype.eventNames=function(){return this._eventsCount>0?Reflect.ownKeys(this._events):[]};var g=window.RTCPeerConnection,y=window.RTCIceCandidate,b=window.RTCSessionDescription;class w extends o{constructor(e){super(),i(this,"pc",void 0),this.pc=new g({iceServers:e}),"ontrack"in this.pc?this.pc.ontrack=this.handleTrackEvent.bind(this):this.pc.onaddstream=this.handleNewStreamEvent.bind(this)}getPeerConnection(){return this.pc}close(){this.pc.close()}setRemoteDescription(e){return this.pc.setRemoteDescription(new b(e))}setLocalDescription(e){return this.pc.setLocalDescription(new b(e))}createAnswer(){var e=this;return r((function*(){return e.pc.createAnswer()}))()}createOffer(){var e=this;return r((function*(){return e.pc.createOffer()}))()}attachIceCandidate(e){return this.pc.addIceCandidate(new y(e))}attachMediaStream(e){var t=this.pc,n=t.getSenders(),r=e.getTracks();n.length?r.forEach(e=>{n.filter(t=>{var n;return(null===(n=t.track)||void 0===n?void 0:n.kind)===e.kind}).forEach(t=>{t.replaceTrack(e)})}):r.forEach(n=>{t.addTrack(n,e)})}handleNewStreamEvent(e){var{stream:t}=e;this.emit("addstream",t)}handleTrackEvent(e){e.streams.forEach(e=>{this.emit("addstream",e)})}}var C="mozGetUserMedia"in navigator?"firefox":"webkitGetUserMedia"in navigator||!1===window.isSecureContext&&"webkitRTCPeerConnection"in window&&!("RTCIceGatherer"in window)?"chrome":navigator.mediaDevices&&navigator.userAgent.match(/Edge\/(\d+).(\d+)$/)?"edge":window.RTCPeerConnection&&navigator.userAgent.match(/AppleWebKit\/(\d+)\./)?"safari":"unknown",L=["vp9","vp8","h264","red","ulpfec","rtx"],k=["opus","isac","g722","pcmu","pcma","cn"];class x{constructor(e,t){this.videoOptions=e,this.audioOptions=t,i(this,"audioIndex",-1),i(this,"videoIndex",-1)}transformPlay(e){return e.sdp?(e.sdp=e.sdp.replace(/profile-level-id=(\w+)/gi,(e,t)=>{var n=parseInt(t,16),r=n>>16&255,i=n>>8&255,s=255&n;return r>66?(r=66,i=224,s=31):0===i&&(i=224),"profile-level-id=".concat((r<<16|i<<8|s).toString(16))}),e):e}transformPublish(e){var t=this.prepareSDP(e),n=this.videoOptions,r=this.audioOptions,i=null,s=()=>"m=audio"===i?r:"m=video"===i?n:null,o=t.filter(Boolean).map(e=>{var[t]=e.split(/\s|:/,1);switch(t){case"m=audio":case"m=video":var o="m=audio"===t?this.audioIndex:this.videoIndex;if(-1!==o&&"chrome"===C){var[a,c,u]=e.split(" ");return"".concat(a," ").concat(c," ").concat(u," ").concat(o)}i=t;break;case"a=rtpmap":var d=/^a=rtpmap:(\d+)\s+(\w+)\/(\d+)/.exec(e);if(!d||"chrome"!==C)break;var l=d[2].toLowerCase();n.bitRate&&L.includes(l)&&(e+="\r\na=fmtp:".concat(d[1]," x-google-min-bitrate=").concat(n.bitRate,";x-google-max-bitrate=").concat(n.bitRate)),r.bitRate&&k.includes(l)&&(e+="\r\na=fmtp:".concat(d[1]," x-google-min-bitrate=").concat(r.bitRate,";x-google-max-bitrate=").concat(r.bitRate));break;case"c=IN":var h=s();if(null!=h&&h.bitRate&&["firefox","safari"].includes(C)){var f=1e3*h.bitRate;e+="\r\nb=TIAS:".concat(.95*f-16e3),e+="\r\nb=AS:".concat(f),e+="\r\nb=CT:".concat(f)}break;case"a=mid":var p=s();p&&"chrome"===C&&(p.bitRate&&(e+="\r\nb=CT:".concat(p.bitRate),e+="\r\nb=AS:".concat(p.bitRate),"frameRate"in p&&p.frameRate&&(e+="\r\na=framerate:".concat(p.frameRate.toFixed(2)))),i=null)}return e}).join("\r\n")+"\r\n";return{type:e.type,sdp:o}}checkLine(e,t){if(/^a=(rtpmap|rtcp-fb|fmtp)/.test(e)){var n=e.split(":");if(n.length>1){var[r,i]=n[1].split(" ");if(!i.startsWith("http")&&!i.startsWith("ur")){var s=parseInt(r,10),o=t.get(s)||[];return o.push(e),t.set(s,o),!1}}}return!0}deliverCheckLine(e,t,n){var r=Array.from(n).find(t=>{var[,n]=t;return n.join("\r\n").includes(e)});if(!r)return[];var[i,s]=r;return"audio"===t?this.audioIndex=i:this.videoIndex=i,"VP8"!==e&&"VP9"!==e?s:s.filter(e=>!e.includes("transport-cc")&&!e.includes("goog-remb")&&!e.includes("nack"))}addAudio(e,t){for(var n="",r=0,i=e.length;r<i;++r){var s=e[r];if(s.startsWith("m=audio"))n="audio";else if(s.startsWith("m=video"))n="video";else if("a=rtcp-mux"===s&&"audio"===n){var o=this.deliverCheckLine(this.audioOptions.codec,"audio",t);e.splice(r+1,0,...o);break}}return e}addVideo(e,t){var n=e.includes("a=rtcp-rsize"),r=e.includes("a=rtcp-mux"),i=!1;if(!n&&!r)return e;var s=this.deliverCheckLine(this.videoOptions.codec,"video",t);return e.map(e=>{if(n){if(!i&&"a=rtcp-rsize"===e)return i=!0,[e].concat(s).join("\r\n")}else if("a=rtcp-mux"===e){if(i)return[e].concat(s).join("\r\n");i=!0}return e})}flattenLines(e){return e.join("\r\n").split("\r\n")}prepareSDP(e){var t=new Map,n=(e.sdp||"").split(/\r\n/);return n=n.filter(e=>e&&this.checkLine(e,t)),n=this.flattenLines(this.addAudio(n,t)),n=this.flattenLines(this.addVideo(n,t))}}class O{constructor(e,t,n){this.url=e,this.streamInfo=t,this.userData=n,i(this,"ws",null),i(this,"pendingCommands",new Map)}connect(){return this.ws?Promise.resolve(this.ws):new Promise((e,t)=>{var n=new WebSocket(this.url);n.binaryType="arraybuffer",n.onopen=()=>e(n),n.onerror=()=>t(),n.onclose=()=>t(),n.onmessage=this.handleSocketData.bind(this),this.ws=n})}disconnect(){this.ws&&(this.ws.close(),this.ws=null)}getOffer(){var e={direction:"play",command:"getOffer"};return this.streamInfo.secureToken&&(e.secureToken=this.streamInfo.secureToken),this.send(e)}sendOffer(e){return this.send({direction:"publish",command:"sendOffer",sdp:e})}sendResponse(e){return this.send({direction:"play",command:"sendResponse",sdp:e})}getAvailableStreams(){return this.send({direction:"play",command:"getAvailableStreams"})}send(e){var n=this;return r((function*(){var r,i=n.ws||(yield n.connect());return n.pendingCommands.has(e.command)||n.pendingCommands.set(e.command,((r={}).promise=new Promise((e,t)=>{r.resolve=e,r.reject=t}),r)),i.send(JSON.stringify(t(t({},e),{},{streamInfo:n.streamInfo,userData:n.userData}))),n.pendingCommands.get(e.command).promise}))()}handleSocketData(e){var t,n=JSON.parse(e.data);200===n.status?(null!==(t=n.streamInfo)&&void 0!==t&&t.sessionId&&(this.streamInfo.sessionId=n.streamInfo.sessionId),this.pendingCommands.has(n.command)&&(this.pendingCommands.get(n.command).resolve(n),this.pendingCommands.delete(n.command))):this.pendingCommands.has(n.command)&&(this.pendingCommands.get(n.command).reject(n),this.pendingCommands.delete(n.command))}}exports.WowzaWebRTCPlayer=class extends o{constructor(e){super(),i(this,"sdpUrl",""),i(this,"applicationName",""),i(this,"streamName",""),i(this,"userData",null),i(this,"sdpHandler",void 0),i(this,"secureToken",void 0),i(this,"constraints",{audio:!0,video:!0}),i(this,"videoConfigs",{bitRate:360,codec:"42e01f",frameRate:29.97}),i(this,"audioConfigs",{codec:"opus",bitRate:64}),i(this,"iceServers",[]),i(this,"mediaStream",null),i(this,"pc",null),e&&this.setConfigurations(e)}setConfigurations(e){e.constraints&&(this.constraints=e.constraints),e.videoConfigs&&(this.videoConfigs=e.videoConfigs),e.audioConfigs&&(this.audioConfigs=e.audioConfigs),e.applicationName&&(this.applicationName=e.applicationName),e.streamName&&(this.streamName=e.streamName),e.sdpUrl&&(this.sdpUrl=e.sdpUrl),void 0!==e.userData&&(this.userData=e.userData),e.iceServers&&(this.iceServers=e.iceServers),e.sdpHandler&&(this.sdpHandler=e.sdpHandler),e.secureToken&&(this.secureToken=e.secureToken),e.mediaStream&&(this.mediaStream=e.mediaStream)}stop(){this.pc&&(this.pc.close(),this.pc=null)}getMediaStream(){return this.mediaStream}getPeerConnection(){return this.pc?this.pc.getPeerConnection():null}publish(e){var t=this;return r((function*(){e&&t.setConfigurations(e);var n=t.createWowzaInstance();try{var r=t.mediaStream;if(null!==r){var i=t.createPeerConnection();i.attachMediaStream(r);var s=new x(t.videoConfigs,t.audioConfigs),o=yield i.createOffer(),a=t.sdpHandler?t.sdpHandler(o,e=>s.transformPublish(e),"publish"):s.transformPublish(o);yield i.setLocalDescription(a);var{sdp:c,iceCandidates:u}=yield n.sendOffer(a);yield i.setRemoteDescription(c),u.forEach(e=>{i.attachIceCandidate(e)})}else Promise.resolve()}finally{n.disconnect()}}))()}getAvailableStreams(){var e=this;return r((function*(){var t=e.createWowzaInstance();try{var{availableStreams:n}=yield t.getAvailableStreams();return n||[]}catch(e){return[]}finally{t.disconnect()}}))()}createWowzaInstance(){return new O(this.sdpUrl,{applicationName:this.applicationName,sessionId:"[empty]",streamName:this.streamName,secureToken:this.secureToken},this.userData)}createPeerConnection(){return this.pc=new w(this.iceServers),this.pc}};
