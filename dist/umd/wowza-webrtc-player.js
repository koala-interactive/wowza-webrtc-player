/**
 * @license wowza-video-webrtc-broadcaster 1.0.0
 * Copyright (c) 2018-2022 Koala Interactive, Inc.
 * License: MIT
 */
var e,t;e=this,t=function(e){"use strict";function t(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function n(e){for(var n=1;n<arguments.length;n++){var r=null!=arguments[n]?arguments[n]:{};n%2?t(Object(r),!0).forEach((function(t){s(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):t(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}function r(e,t,n,r,i,s,o){try{var a=e[s](o),c=a.value}catch(e){return void n(e)}a.done?t(c):Promise.resolve(c).then(r,i)}function i(e){return function(){var t=this,n=arguments;return new Promise((function(i,s){var o=e.apply(t,n);function a(e){r(o,i,s,a,c,"next",e)}function c(e){r(o,i,s,a,c,"throw",e)}a(void 0)}))}}function s(e,t,n){return(t=function(e){var t=function(e,t){if("object"!=typeof e||null===e)return e;var n=e[Symbol.toPrimitive];if(void 0!==n){var r=n.call(e,t||"default");if("object"!=typeof r)return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==typeof t?t:t+""}(t))in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(){}function a(){a.init.call(this)}function c(e){return void 0===e._maxListeners?a.defaultMaxListeners:e._maxListeners}function u(e,t,n){if(t)e.call(n);else for(var r=e.length,i=g(e,r),s=0;s<r;++s)i[s].call(n)}function d(e,t,n,r){if(t)e.call(n,r);else for(var i=e.length,s=g(e,i),o=0;o<i;++o)s[o].call(n,r)}function l(e,t,n,r,i){if(t)e.call(n,r,i);else for(var s=e.length,o=g(e,s),a=0;a<s;++a)o[a].call(n,r,i)}function h(e,t,n,r,i,s){if(t)e.call(n,r,i,s);else for(var o=e.length,a=g(e,o),c=0;c<o;++c)a[c].call(n,r,i,s)}function f(e,t,n,r){if(t)e.apply(n,r);else for(var i=e.length,s=g(e,i),o=0;o<i;++o)s[o].apply(n,r)}function p(e,t,n,r){var i,s,a,u;if("function"!=typeof n)throw new TypeError('"listener" argument must be a function');if((s=e._events)?(s.newListener&&(e.emit("newListener",t,n.listener?n.listener:n),s=e._events),a=s[t]):(s=e._events=new o,e._eventsCount=0),a){if("function"==typeof a?a=s[t]=r?[n,a]:[a,n]:r?a.unshift(n):a.push(n),!a.warned&&(i=c(e))&&i>0&&a.length>i){a.warned=!0;var d=Error("Possible EventEmitter memory leak detected. "+a.length+" "+t+" listeners added. Use emitter.setMaxListeners() to increase limit");d.name="MaxListenersExceededWarning",d.emitter=e,d.type=t,d.count=a.length,u=d,"function"==typeof console.warn?console.warn(u):console.log(u)}}else a=s[t]=n,++e._eventsCount;return e}function m(e,t,n){var r=!1;function i(){e.removeListener(t,i),r||(r=!0,n.apply(e,arguments))}return i.listener=n,i}function v(e){var t=this._events;if(t){var n=t[e];if("function"==typeof n)return 1;if(n)return n.length}return 0}function g(e,t){for(var n=Array(t);t--;)n[t]=e[t];return n}o.prototype=Object.create(null),a.EventEmitter=a,a.usingDomains=!1,a.prototype.domain=void 0,a.prototype._events=void 0,a.prototype._maxListeners=void 0,a.defaultMaxListeners=10,a.init=function(){this.domain=null,a.usingDomains&&(void 0).active,this._events&&this._events!==Object.getPrototypeOf(this)._events||(this._events=new o,this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},a.prototype.setMaxListeners=function(e){if("number"!=typeof e||e<0||isNaN(e))throw new TypeError('"n" argument must be a positive number');return this._maxListeners=e,this},a.prototype.getMaxListeners=function(){return c(this)},a.prototype.emit=function(e){var t,n,r,i,s,o,a,c="error"===e;if(o=this._events)c=c&&null==o.error;else if(!c)return!1;if(a=this.domain,c){if(t=arguments[1],!a){if(t instanceof Error)throw t;var p=Error('Uncaught, unspecified "error" event. ('+t+")");throw p.context=t,p}return t||(t=Error('Uncaught, unspecified "error" event')),t.domainEmitter=this,t.domain=a,t.domainThrown=!1,a.emit("error",t),!1}if(!(n=o[e]))return!1;var m="function"==typeof n;switch(r=arguments.length){case 1:u(n,m,this);break;case 2:d(n,m,this,arguments[1]);break;case 3:l(n,m,this,arguments[1],arguments[2]);break;case 4:h(n,m,this,arguments[1],arguments[2],arguments[3]);break;default:for(i=Array(r-1),s=1;s<r;s++)i[s-1]=arguments[s];f(n,m,this,i)}return!0},a.prototype.addListener=function(e,t){return p(this,e,t,!1)},a.prototype.on=a.prototype.addListener,a.prototype.prependListener=function(e,t){return p(this,e,t,!0)},a.prototype.once=function(e,t){if("function"!=typeof t)throw new TypeError('"listener" argument must be a function');return this.on(e,m(this,e,t)),this},a.prototype.prependOnceListener=function(e,t){if("function"!=typeof t)throw new TypeError('"listener" argument must be a function');return this.prependListener(e,m(this,e,t)),this},a.prototype.removeListener=function(e,t){var n,r,i,s,a;if("function"!=typeof t)throw new TypeError('"listener" argument must be a function');if(!(r=this._events))return this;if(!(n=r[e]))return this;if(n===t||n.listener&&n.listener===t)0==--this._eventsCount?this._events=new o:(delete r[e],r.removeListener&&this.emit("removeListener",e,n.listener||t));else if("function"!=typeof n){for(i=-1,s=n.length;s-- >0;)if(n[s]===t||n[s].listener&&n[s].listener===t){a=n[s].listener,i=s;break}if(i<0)return this;if(1===n.length){if(n[0]=void 0,0==--this._eventsCount)return this._events=new o,this;delete r[e]}else!function(e,t){for(var n=t,r=n+1,i=e.length;r<i;n+=1,r+=1)e[n]=e[r];e.pop()}(n,i);r.removeListener&&this.emit("removeListener",e,a||t)}return this},a.prototype.removeAllListeners=function(e){var t,n;if(!(n=this._events))return this;if(!n.removeListener)return 0===arguments.length?(this._events=new o,this._eventsCount=0):n[e]&&(0==--this._eventsCount?this._events=new o:delete n[e]),this;if(0===arguments.length){for(var r,i=Object.keys(n),s=0;s<i.length;++s)"removeListener"!==(r=i[s])&&this.removeAllListeners(r);return this.removeAllListeners("removeListener"),this._events=new o,this._eventsCount=0,this}if("function"==typeof(t=n[e]))this.removeListener(e,t);else if(t)do{this.removeListener(e,t[t.length-1])}while(t[0]);return this},a.prototype.listeners=function(e){var t,n=this._events;return n&&(t=n[e])?"function"==typeof t?[t.listener||t]:function(e){for(var t=Array(e.length),n=0;n<t.length;++n)t[n]=e[n].listener||e[n];return t}(t):[]},a.listenerCount=function(e,t){return"function"==typeof e.listenerCount?e.listenerCount(t):v.call(e,t)},a.prototype.listenerCount=v,a.prototype.eventNames=function(){return this._eventsCount>0?Reflect.ownKeys(this._events):[]};var y=window.RTCPeerConnection,b=window.RTCIceCandidate,w=window.RTCSessionDescription;class C extends a{constructor(e){super(),s(this,"pc",void 0),this.pc=new y({iceServers:e}),"ontrack"in this.pc?this.pc.ontrack=this.handleTrackEvent.bind(this):this.pc.onaddstream=this.handleNewStreamEvent.bind(this)}getPeerConnection(){return this.pc}close(){this.pc.close()}setRemoteDescription(e){return this.pc.setRemoteDescription(new w(e))}setLocalDescription(e){return this.pc.setLocalDescription(new w(e))}createAnswer(){var e=this;return i((function*(){return e.pc.createAnswer()}))()}createOffer(){var e=this;return i((function*(){return e.pc.createOffer()}))()}attachIceCandidate(e){return this.pc.addIceCandidate(new b(e))}attachMediaStream(e){var t=this.pc,n=t.getSenders(),r=e.getTracks();n.length?r.forEach(e=>{n.filter(t=>{var n;return(null===(n=t.track)||void 0===n?void 0:n.kind)===e.kind}).forEach(t=>{t.replaceTrack(e)})}):r.forEach(n=>{t.addTrack(n,e)})}handleNewStreamEvent(e){var{stream:t}=e;this.emit("addstream",t)}handleTrackEvent(e){e.streams.forEach(e=>{this.emit("addstream",e)})}}var L="mozGetUserMedia"in navigator?"firefox":"webkitGetUserMedia"in navigator||!1===window.isSecureContext&&"webkitRTCPeerConnection"in window&&!("RTCIceGatherer"in window)?"chrome":navigator.mediaDevices&&navigator.userAgent.match(/Edge\/(\d+).(\d+)$/)?"edge":window.RTCPeerConnection&&navigator.userAgent.match(/AppleWebKit\/(\d+)\./)?"safari":"unknown",k=["vp9","vp8","h264","red","ulpfec","rtx"],x=["opus","isac","g722","pcmu","pcma","cn"];class O{constructor(e,t){this.videoOptions=e,this.audioOptions=t,s(this,"audioIndex",-1),s(this,"videoIndex",-1)}transformPlay(e){return e.sdp?(e.sdp=e.sdp.replace(/profile-level-id=(\w+)/gi,(e,t)=>{var n=parseInt(t,16),r=n>>16&255,i=n>>8&255,s=255&n;return r>66?(r=66,i=224,s=31):0===i&&(i=224),"profile-level-id=".concat((r<<16|i<<8|s).toString(16))}),e):e}transformPublish(e){var t=this.prepareSDP(e),n=this.videoOptions,r=this.audioOptions,i=null,s=()=>"m=audio"===i?r:"m=video"===i?n:null,o=t.filter(Boolean).map(e=>{var[t]=e.split(/\s|:/,1);switch(t){case"m=audio":case"m=video":var o="m=audio"===t?this.audioIndex:this.videoIndex;if(-1!==o&&"chrome"===L){var[a,c,u]=e.split(" ");return"".concat(a," ").concat(c," ").concat(u," ").concat(o)}i=t;break;case"a=rtpmap":var d=/^a=rtpmap:(\d+)\s+(\w+)\/(\d+)/.exec(e);if(!d||"chrome"!==L)break;var l=d[2].toLowerCase();n.bitRate&&k.includes(l)&&(e+="\r\na=fmtp:".concat(d[1]," x-google-min-bitrate=").concat(n.bitRate,";x-google-max-bitrate=").concat(n.bitRate)),r.bitRate&&x.includes(l)&&(e+="\r\na=fmtp:".concat(d[1]," x-google-min-bitrate=").concat(r.bitRate,";x-google-max-bitrate=").concat(r.bitRate));break;case"c=IN":var h=s();if(null!=h&&h.bitRate&&["firefox","safari"].includes(L)){var f=1e3*h.bitRate;e+="\r\nb=TIAS:".concat(.95*f-16e3),e+="\r\nb=AS:".concat(f),e+="\r\nb=CT:".concat(f)}break;case"a=mid":var p=s();p&&"chrome"===L&&(p.bitRate&&(e+="\r\nb=CT:".concat(p.bitRate),e+="\r\nb=AS:".concat(p.bitRate),"frameRate"in p&&p.frameRate&&(e+="\r\na=framerate:".concat(p.frameRate.toFixed(2)))),i=null)}return e}).join("\r\n")+"\r\n";return{type:e.type,sdp:o}}checkLine(e,t){if(/^a=(rtpmap|rtcp-fb|fmtp)/.test(e)){var n=e.split(":");if(n.length>1){var[r,i]=n[1].split(" ");if(!i.startsWith("http")&&!i.startsWith("ur")){var s=parseInt(r,10),o=t.get(s)||[];return o.push(e),t.set(s,o),!1}}}return!0}deliverCheckLine(e,t,n){var r=Array.from(n).find(t=>{var[,n]=t;return n.join("\r\n").includes(e)});if(!r)return[];var[i,s]=r;return"audio"===t?this.audioIndex=i:this.videoIndex=i,"VP8"!==e&&"VP9"!==e?s:s.filter(e=>!e.includes("transport-cc")&&!e.includes("goog-remb")&&!e.includes("nack"))}addAudio(e,t){for(var n="",r=0,i=e.length;r<i;++r){var s=e[r];if(s.startsWith("m=audio"))n="audio";else if(s.startsWith("m=video"))n="video";else if("a=rtcp-mux"===s&&"audio"===n){var o=this.deliverCheckLine(this.audioOptions.codec,"audio",t);e.splice(r+1,0,...o);break}}return e}addVideo(e,t){var n=e.includes("a=rtcp-rsize"),r=e.includes("a=rtcp-mux"),i=!1;if(!n&&!r)return e;var s=this.deliverCheckLine(this.videoOptions.codec,"video",t);return e.map(e=>{if(n){if(!i&&"a=rtcp-rsize"===e)return i=!0,[e].concat(s).join("\r\n")}else if("a=rtcp-mux"===e){if(i)return[e].concat(s).join("\r\n");i=!0}return e})}flattenLines(e){return e.join("\r\n").split("\r\n")}prepareSDP(e){var t=new Map,n=(e.sdp||"").split(/\r\n/);return n=n.filter(e=>e&&this.checkLine(e,t)),n=this.flattenLines(this.addAudio(n,t)),n=this.flattenLines(this.addVideo(n,t))}}class S{constructor(e,t,n){this.url=e,this.streamInfo=t,this.userData=n,s(this,"ws",null),s(this,"pendingCommands",new Map)}connect(){return this.ws?Promise.resolve(this.ws):new Promise((e,t)=>{var n=new WebSocket(this.url);n.binaryType="arraybuffer",n.onopen=()=>e(n),n.onerror=()=>t(),n.onclose=()=>t(),n.onmessage=this.handleSocketData.bind(this),this.ws=n})}disconnect(){this.ws&&(this.ws.close(),this.ws=null)}getOffer(){var e={direction:"play",command:"getOffer"};return this.streamInfo.secureToken&&(e.secureToken=this.streamInfo.secureToken),this.send(e)}sendOffer(e){return this.send({direction:"publish",command:"sendOffer",sdp:e})}sendResponse(e){return this.send({direction:"play",command:"sendResponse",sdp:e})}getAvailableStreams(){return this.send({direction:"play",command:"getAvailableStreams"})}send(e){var t=this;return i((function*(){var r,i=t.ws||(yield t.connect());return t.pendingCommands.has(e.command)||t.pendingCommands.set(e.command,((r={}).promise=new Promise((e,t)=>{r.resolve=e,r.reject=t}),r)),i.send(JSON.stringify(n(n({},e),{},{streamInfo:t.streamInfo,userData:t.userData}))),t.pendingCommands.get(e.command).promise}))()}handleSocketData(e){var t,n=JSON.parse(e.data);200===n.status?(null!==(t=n.streamInfo)&&void 0!==t&&t.sessionId&&(this.streamInfo.sessionId=n.streamInfo.sessionId),this.pendingCommands.has(n.command)&&(this.pendingCommands.get(n.command).resolve(n),this.pendingCommands.delete(n.command))):this.pendingCommands.has(n.command)&&(this.pendingCommands.get(n.command).reject(n),this.pendingCommands.delete(n.command))}}e.WowzaWebRTCPlayer=class extends a{constructor(e){super(),s(this,"sdpUrl",""),s(this,"applicationName",""),s(this,"streamName",""),s(this,"userData",null),s(this,"sdpHandler",void 0),s(this,"secureToken",void 0),s(this,"constraints",{audio:!0,video:!0}),s(this,"videoConfigs",{bitRate:360,codec:"42e01f",frameRate:29.97}),s(this,"audioConfigs",{codec:"opus",bitRate:64}),s(this,"iceServers",[]),s(this,"mediaStream",null),s(this,"pc",null),e&&this.setConfigurations(e)}setConfigurations(e){e.constraints&&(this.constraints=e.constraints),e.videoConfigs&&(this.videoConfigs=e.videoConfigs),e.audioConfigs&&(this.audioConfigs=e.audioConfigs),e.applicationName&&(this.applicationName=e.applicationName),e.streamName&&(this.streamName=e.streamName),e.sdpUrl&&(this.sdpUrl=e.sdpUrl),void 0!==e.userData&&(this.userData=e.userData),e.iceServers&&(this.iceServers=e.iceServers),e.sdpHandler&&(this.sdpHandler=e.sdpHandler),e.secureToken&&(this.secureToken=e.secureToken),e.mediaStream&&(this.mediaStream=e.mediaStream)}stop(){this.pc&&(this.pc.close(),this.pc=null)}getMediaStream(){return this.mediaStream}getPeerConnection(){return this.pc?this.pc.getPeerConnection():null}publish(e){var t=this;return i((function*(){e&&t.setConfigurations(e);var n=t.createWowzaInstance();try{var r=t.mediaStream;if(null!==r){var i=t.createPeerConnection();i.attachMediaStream(r);var s=new O(t.videoConfigs,t.audioConfigs),o=yield i.createOffer(),a=t.sdpHandler?t.sdpHandler(o,e=>s.transformPublish(e),"publish"):s.transformPublish(o);yield i.setLocalDescription(a);var{sdp:c,iceCandidates:u}=yield n.sendOffer(a);yield i.setRemoteDescription(c),u.forEach(e=>{i.attachIceCandidate(e)})}else Promise.resolve()}finally{n.disconnect()}}))()}getAvailableStreams(){var e=this;return i((function*(){var t=e.createWowzaInstance();try{var{availableStreams:n}=yield t.getAvailableStreams();return n||[]}catch(e){return[]}finally{t.disconnect()}}))()}createWowzaInstance(){return new S(this.sdpUrl,{applicationName:this.applicationName,sessionId:"[empty]",streamName:this.streamName,secureToken:this.secureToken},this.userData)}createPeerConnection(){return this.pc=new C(this.iceServers),this.pc}},Object.defineProperty(e,"__esModule",{value:!0})},"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e=e||self)["wowza-video-webrtc-broadcaster"]={});
